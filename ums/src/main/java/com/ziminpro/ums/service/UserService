package com.ziminpro.ums.service;

import com.ziminpro.ums.model.User;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.time.Instant;
import java.time.Duration;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

@Service
public class UserService {

    private final Map<String, User> users = new HashMap<>();
    private Long idCounter = 1L;

    // Store tokens and expiry
    private final Map<String, TokenInfo> tokens = new HashMap<>();

    @Autowired
    private PasswordEncoder passwordEncoder;

    // -------------------- Local User Methods --------------------

    public void saveUser(User user) {
        user.setId(idCounter++);
        user.setPassword(passwordEncoder.encode(user.getPassword()));
        users.put(user.getUsername(), user);
    }

    public User findByUsername(String username) {
        return users.get(username);
    }

    public boolean checkCredentials(String username, String rawPassword) {
        User user = users.get(username);
        return user != null && passwordEncoder.matches(rawPassword, user.getPassword());
    }

    // -------------------- OAuth2 / Token Methods --------------------

    public String generateToken(User user) {
        String token = UUID.randomUUID().toString();
        Instant expiry = Instant.now().plus(Duration.ofMinutes(15));
        tokens.put(token, new TokenInfo(user.getUsername(), expiry));
        return token;
    }

    public String validateToken(String token) {
        TokenInfo info = tokens.get(token);
        if (info == null) return null;

        if (Instant.now().isAfter(info.getExpiry())) {
            tokens.remove(token);
            return null;
        }
        return info.getUsername();
    }

    public void revokeToken(String token) {
        tokens.remove(token);
    }

    // -------------------- Inner class --------------------
    private static class TokenInfo {
        private final String username;
        private final Instant expiry;
        public TokenInfo(String username, Instant expiry) {
            this.username = username;
            this.expiry = expiry;
        }
        public String getUsername() { return username; }
        public Instant getExpiry() { return expiry; }
    }
}
